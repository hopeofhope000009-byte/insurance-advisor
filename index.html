<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿é™© AI é¡¾é—® - ä¸“ä¸šç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        nav { display: flex; justify-content: center; background: #1e40af; padding: 0.5rem; gap: 10px; sticky: top; }
        .nav-btn { background: transparent; border: none; color: white; padding: 0.6rem 1.2rem; cursor: pointer; border-radius: 4px; font-weight: 500; }
        .nav-btn.active { background: rgba(255,255,255,0.2); border: 1px solid white; }
        main { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        .section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .section.active { display: block; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input, textarea { width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; transition: 0.2s; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        #report-display { margin-top: 2rem; padding: 1.5rem; border-radius: 8px; background: #ffffff; border: 1px solid #e2e8f0; line-height: 1.8; }
        .product-card { background: #f1f5f9; padding: 1rem; margin-bottom: 0.8rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { color: #ef4444; cursor: pointer; font-size: 0.9rem; font-weight: bold; }
        .loading-ring { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header><h1>ğŸ¥ ä¸ªäººä¿é™©é¡¾é—® AI ç³»ç»Ÿ</h1></header>
    <nav>
        <button onclick="showSection('upload', this)" class="nav-btn active">1. æ‰¹é‡ä¸Šä¼ </button>
        <button onclick="showSection('library', this)" class="nav-btn">2. äº§å“åº“</button>
        <button onclick="showSection('client', this)" class="nav-btn">3. æ™ºèƒ½åˆ†æ</button>
    </nav>

    <main>
        <section id="upload" class="section active">
            <h2>ğŸ“ æ‰¹é‡å¯¼å…¥æ–‡ä»¶å¤¹</h2>
            <p style="color: #64748b;">é€‰æ‹©åŒ…å«å¤šä¸ªä¿é™© PDF çš„æ–‡ä»¶å¤¹ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ‰¹é‡è¯»å–å†…å®¹ã€‚</p>
            <div class="form-group">
                <label>æ‰€å±ä¿é™©å…¬å¸ (ä¾‹å¦‚ï¼šå¹³å®‰ã€å‹é‚¦):</label>
                <input type="text" id="company-name" placeholder="è¾“å…¥å…¬å¸åç§°">
            </div>
            <div class="form-group">
                <label>é€‰æ‹©æ–‡ä»¶å¤¹:</label>
                <input type="file" id="product-file" webkitdirectory directory multiple>
            </div>
            <button onclick="handleUpload()" class="btn-primary" id="up-btn">å¼€å§‹æ‰¹é‡å¯¼å…¥</button>
            <div id="up-progress" style="margin-top:15px; font-weight:bold; color:var(--primary);"></div>
        </section>

        <section id="library" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>ğŸ“š å½“å‰äº§å“åº“</h2>
                <button onclick="clearLibrary()" style="color:#ef4444; border:none; background:none; cursor:pointer; font-weight:bold;">[æ¸…ç©ºå…¨éƒ¨]</button>
            </div>
            <div id="products-list"></div>
        </section>

        <section id="client" class="section">
            <h2>ğŸ“‹ å®¢æˆ·éœ€æ±‚åˆ†æ</h2>
            <div class="form-group">
                <label>å®¢æˆ·èƒŒæ™¯/éœ€æ±‚:</label>
                <textarea id="client-requirements" rows="5" placeholder="ä¾‹å¦‚ï¼š35å²å¥³æ€§ï¼Œé¢„ç®—1ä¸‡/å¹´ï¼Œæƒ³è¦è¦†ç›–é‡ç–¾å’Œé«˜ç«¯åŒ»ç–—..."></textarea>
            </div>
            <button class="btn-primary" id="analyze-btn" onclick="runAI()">ç”Ÿæˆä¸“å®¶å»ºè®®æŠ¥å‘Š</button>
            
            <div id="report-display" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3 style="margin:0;">ğŸ“Š AI åˆ†æç»“æœ</h3>
                    <button onclick="window.print()" style="cursor:pointer;">æ‰“å°/è½¬PDF</button>
                </div>
                <div id="report-content"></div>
            </div>
        </section>
    </main>

    <script>
        const GEMINI_KEY = "AIzaSyCFzpAWoCorwVgcRwKqiDDwldzz7eJnBGc";
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let productLibrary = JSON.parse(localStorage.getItem('insurance_docs')) || [];

        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'library') renderLibrary();
        }

        async function handleUpload() {
            const fileInput = document.getElementById('product-file');
            const files = fileInput.files;
            const company = document.getElementById('company-name').value || "æœªå‘½åå…¬å¸";
            const btn = document.getElementById('up-btn');
            const progress = document.getElementById('up-progress');
            
            if(!files.length) return alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶ï¼");
            
            btn.disabled = true;
            let successCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.name.toLowerCase().endsWith('.pdf')) {
                    progress.innerText = `æ­£åœ¨å¤„ç† (${i+1}/${files.length}): ${file.name}`;
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                        let text = "";
                        // Read up to 3 pages to stay within local storage limits
                        for (let p = 1; p <= Math.min(pdf.numPages, 3); p++) {
                            const page = await pdf.getPage(p);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ");
                        }
                        productLibrary.push({ 
                            id: Date.now() + Math.random(), 
                            company, 
                            fileName: file.name, 
                            content: text.slice(0, 3500) 
                        });
                        successCount++;
                    } catch (err) {
                        console.error("Error reading file:", file.name);
                    }
                }
            }

            localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
            btn.disabled = false;
            btn.innerText = "å¼€å§‹æ‰¹é‡å¯¼å…¥";
            progress.innerText = `âœ… æˆåŠŸå¯¼å…¥ ${successCount} ä¸ª PDF æ–‡ä»¶ï¼`;
            fileInput.value = ""; // Reset input
        }

        function renderLibrary() {
            const list = document.getElementById('products-list');
            list.innerHTML = productLibrary.length ? '' : '<p style="color:gray;">åº“ä¸­æš‚æ— äº§å“ï¼Œè¯·å…ˆä¸Šä¼ ã€‚</p>';
            productLibrary.forEach(item => {
                const div = document.createElement('div');
                div.className = 'product-card';
                div.innerHTML = `<div><strong>[${item.company}]</strong> ${item.fileName}</div>
                <span class="delete-btn" onclick="deleteItem(${item.id})">åˆ é™¤</span>`;
                list.appendChild(div);
            });
        }

        function deleteItem(id) {
            productLibrary = productLibrary.filter(p => p.id !== id);
            localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
            renderLibrary();
        }

        function clearLibrary() { if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²ä¿å­˜çš„äº§å“å—ï¼Ÿ')) { productLibrary = []; localStorage.removeItem('insurance_docs'); renderLibrary(); } }

        async function runAI() {
            const reqs = document.getElementById('client-requirements').value;
            const btn = document.getElementById('analyze-btn');
            const reportDiv = document.getElementById('report-display');
            const contentDiv = document.getElementById('report-content');

            if(!productLibrary.length) return alert("äº§å“åº“æ˜¯ç©ºçš„ï¼Œè¯·å…ˆä¸Šä¼ ä¿é™©æ–‡ä»¶ã€‚");
            if(!reqs) return alert("è¯·è¾“å…¥å®¢æˆ·éœ€æ±‚ã€‚");

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-ring"></span> AI æ­£åœ¨æ·±åº¦åˆ†æä¸­...';

            const context = productLibrary.map(p => `äº§å“[å…¬å¸:${p.company}, æ–‡ä»¶å:${p.fileName}] å†…å®¹æ‘˜è¦: ${p.content}`).join("\n---\n");
            
            const prompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±ä¿é™©ä¸“å®¶ã€‚
            å®¢æˆ·èƒŒæ™¯éœ€æ±‚ï¼š${reqs}
            
            ç°æœ‰äº§å“åº“å†…å®¹ï¼š
            ${context}
            
            ä»»åŠ¡ï¼š
            1. ä»äº§å“åº“ä¸­æŒ‘é€‰æœ€åŒ¹é…çš„äº§å“ã€‚
            2. ç»™å‡ºè¯¦ç»†çš„æ¨èç†ç”±ã€‚
            3. æŒ‡å‡ºè¯¥äº§å“çš„æ ¸å¿ƒä¼˜ç¼ºç‚¹ã€‚
            4. ç»™å‡ºæœ€ç»ˆæŠ•ä¿å»ºè®®ã€‚`;

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await resp.json();

                // SAFETY CHECK: Ensure data and candidates exist
                if (data && data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const md = data.candidates[0].content.parts[0].text;
                    reportDiv.style.display = 'block';
                    contentDiv.innerHTML = marked.parse(md);
                    reportDiv.scrollIntoView({ behavior: 'smooth' });
                } else {
                    // This handles the "Undefined" error by showing exactly what the AI sent back
                    const errorMsg = data.error ? data.error.message : "AI è¿”å›äº†ç©ºç»“æœï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç¨åå†è¯•ã€‚";
                    throw new Error(errorMsg);
                }
            } catch (e) {
                alert("åˆ†æå¤±è´¥ï¼š" + e.message);
                console.error("Full Error Info:", e);
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆä¸“å®¶å»ºè®®æŠ¥å‘Š";
            }
        }
    </script>
</body>
</html>
