<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI ä¿é™©ä¸“å®¶ - 2.0 å‡çº§ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { font-family: system-ui, sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .card { border: 1px solid #e2e8f0; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        button { padding: 12px 24px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; width: 100%; }
        button:disabled { background: #94a3b8; }
        textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; margin-top: 10px; }
        #status { color: #059669; font-weight: bold; margin-top: 10px; }
        #out { margin-top: 25px; line-height: 1.7; border-top: 3px solid var(--primary); padding-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#1e40af;">ğŸ›¡ï¸ ä¿é™©é¡¾é—® AI ç³»ç»Ÿ (v2.0)</h2>
    
    <div class="card">
        <h3>1. å¯¼å…¥ä¿é™©äº§å“æ–‡ä»¶å¤¹</h3>
        <input type="file" id="files" webkitdirectory directory multiple style="margin-bottom:10px;">
        <button onclick="upload()">æ‰¹é‡è§£æ PDF</button>
        <div id="status"></div>
    </div>

    <div class="card">
        <h3>2. å®¢æˆ·éœ€æ±‚åˆ†æ</h3>
        <textarea id="reqs" rows="5" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ·35å²ï¼Œæƒ³ä¹°é‡ç–¾é™©ï¼Œå…³æ³¨ç™Œç—‡ä¿éšœ..."></textarea>
        <button id="btn" onclick="run()" style="margin-top:15px;">å¼€å§‹æ™ºèƒ½åˆ†ææŠ¥å‘Š</button>
    </div>

    <div id="out"></div>
</div>

<script>
    // ä½¿ç”¨ä½ çš„æ–° KEY
    const KEY = "AIzaSyArJg6XfI4gWHhK46xsMc0zHUdJlfa98QY";
    let db = JSON.parse(localStorage.getItem('docs')) || [];

    async function upload() {
        const fileList = document.getElementById('files').files;
        const status = document.getElementById('status');
        if(!fileList.length) return alert("è¯·é€‰æ‹©æ–‡ä»¶å¤¹");
        
        status.innerText = "â³ æ­£åœ¨åŠªåŠ›è§£æ PDF...";
        
        for (let f of fileList) {
            if (f.name.toLowerCase().endsWith('.pdf')) {
                try {
                    const data = await f.arrayBuffer();
                    const pdf = await window['pdfjs-dist/build/pdf'].getDocument({data}).promise;
                    let text = "";
                    for (let i=1; i<=Math.min(pdf.numPages, 3); i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(it => it.str).join(" ");
                    }
                    db.push({ name: f.name, text: text.slice(0, 3000) });
                } catch (e) { console.error("è·³è¿‡æŸåæ–‡ä»¶:", f.name); }
            }
        }
        localStorage.setItem('docs', JSON.stringify(db));
        status.innerText = `âœ… æˆåŠŸè§£æå¹¶å¯¼å…¥ ${db.length} ä¸ªæ–‡ä»¶`;
    }

    async function run() {
        const btn = document.getElementById('btn');
        const out = document.getElementById('out');
        const userReq = document.getElementById('reqs').value;

        if (db.length === 0) return alert("åº“ä¸­æ²¡æœ‰äº§å“ï¼Œè¯·å…ˆä¸Šä¼ ");
        if (!userReq) return alert("è¯·è¾“å…¥éœ€æ±‚");

        btn.disabled = true;
        btn.innerText = "ğŸš€ AI æ­£åœ¨æ·±åº¦å¯¹æ¯”äº§å“å¹¶æ’°å†™æŠ¥å‘Š...";

        // æ„å»ºä¸Šä¸‹æ–‡
        const context = db.map(d => `[æ–‡ä»¶å: ${d.name}] å†…å®¹: ${d.text}`).join("\n\n");
        const prompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¿é™©ç²¾ç®—é¡¾é—®ã€‚
        å®¢æˆ·éœ€æ±‚ï¼š${userReq}
        
        äº§å“åº“å†…å®¹ï¼š
        ${context}
        
        è¯·å¯¹æ¯”ä»¥ä¸Šäº§å“ï¼Œç»™å‡ºæœ€ä¸“ä¸šçš„æ–¹æ¡ˆå»ºè®®ã€‚`;

        try {
            // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ä½ åˆ—è¡¨ä¸­çš„ models/gemini-2.0-flash
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${KEY}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);

            const resultHtml = marked.parse(data.candidates[0].content.parts[0].text);
            out.innerHTML = resultHtml;
            out.scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            alert("åˆ†æå¤±è´¥ï¼š" + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "å¼€å§‹æ™ºèƒ½åˆ†ææŠ¥å‘Š";
        }
    }
</script>
</body>
</html>
