<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ä¿é™©ä¸“å®¶ç³»ç»Ÿ (æœ€æ–° Key é€‚é…ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        header { background: var(--primary); color: white; padding: 1.2rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        nav { display: flex; justify-content: center; background: #1e40af; padding: 0.5rem; gap: 15px; }
        .nav-btn { background: transparent; border: none; color: white; padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px; font-size: 0.95rem; }
        .nav-btn.active { background: rgba(255,255,255,0.2); font-weight: bold; }
        main { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .section { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: none; }
        .section.active { display: block; }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.4rem; font-weight: 600; }
        input, textarea { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 0.85rem; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1rem; font-weight: bold; }
        .btn-primary:disabled { background: #94a3b8; }
        #report-display { margin-top: 1.5rem; padding: 1.5rem; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; }
        .product-card { background: #f8fafc; padding: 0.8rem; border: 1px solid #e2e8f0; margin-bottom: 0.6rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { color: #ef4444; cursor: pointer; font-size: 0.85rem; }
    </style>
</head>
<body>

    <header><h1>ğŸ¥ ä¿é™©é¡¾é—® AI ç³»ç»Ÿ</h1></header>
    <nav>
        <button onclick="showSection('upload', this)" class="nav-btn active">1. å¯¼å…¥åº“</button>
        <button onclick="showSection('library', this)" class="nav-btn">2. äº§å“åº“</button>
        <button onclick="showSection('client', this)" class="nav-btn">3. åˆ†ææŠ¥å‘Š</button>
    </nav>

    <main>
        <section id="upload" class="section active">
            <h2>ğŸ“ æ‰¹é‡å¯¼å…¥ PDF</h2>
            <div class="form-group">
                <label>å…¬å¸åç§°:</label>
                <input type="text" id="company-name" placeholder="å¦‚ï¼šå‹é‚¦ã€å¹³å®‰">
            </div>
            <div class="form-group">
                <label>é€‰æ‹©æ–‡ä»¶å¤¹ (æ‰¹é‡è§£æ):</label>
                <input type="file" id="product-file" webkitdirectory directory multiple>
            </div>
            <button onclick="handleUpload()" class="btn-primary" id="up-btn">è§£æå¹¶å­˜å‚¨åˆ°æµè§ˆå™¨</button>
            <p id="up-status" style="margin-top:10px; color: #059669; font-weight: bold;"></p>
        </section>

        <section id="library" class="section">
            <h2>ğŸ“š å½“å‰äº§å“åº“</h2>
            <div id="products-list"></div>
            <button onclick="clearLibrary()" style="margin-top:10px; color:red; border:none; background:none; cursor:pointer;">[æ¸…ç©ºäº§å“åº“]</button>
        </section>

        <section id="client" class="section">
            <h2>ğŸ“‹ å®¢æˆ·éœ€æ±‚ä¸åˆ†æ</h2>
            <textarea id="client-requirements" rows="5" placeholder="ä¾‹å¦‚ï¼š30å²å¥³æ€§ï¼Œé¢„ç®—1.5ä¸‡ï¼Œå…³æ³¨æµ·å¤–åŒ»ç–—..."></textarea>
            <button class="btn-primary" id="analyze-btn" onclick="runAI()" style="margin-top:1rem;">ç”Ÿæˆ AI å»ºè®®</button>
            <div id="report-display" style="display:none;">
                <div id="report-content"></div>
            </div>
        </section>
    </main>

    <script>
        // --- ä½¿ç”¨ä½ çš„æ–° KEY ---
        const NEW_API_KEY = "AIzaSyArJg6XfI4gWHhK46xsMc0zHUdJlfa98QY";
        
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let productLibrary = JSON.parse(localStorage.getItem('insurance_docs')) || [];

        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'library') renderLibrary();
        }

        async function handleUpload() {
            const files = document.getElementById('product-file').files;
            const company = document.getElementById('company-name').value || "æœªçŸ¥";
            const btn = document.getElementById('up-btn');
            const status = document.getElementById('up-status');
            if(!files.length) return alert("è¯·é€‰æ‹©æ–‡ä»¶å¤¹");
            btn.disabled = true;
            status.innerText = "â³ æ­£åœ¨è§£æå¹¶å­˜å‚¨...";
            
            for (let file of files) {
                if (file.name.toLowerCase().endsWith('.pdf')) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                        let text = "";
                        for (let i = 1; i <= Math.min(pdf.numPages, 3); i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ");
                        }
                        productLibrary.push({ id: Date.now()+Math.random(), company, fileName: file.name, content: text.slice(0, 3000) });
                    } catch(e) { console.error("è§£æå‡ºé”™:", file.name); }
                }
            }
            localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
            btn.disabled = false;
            status.innerText = "âœ… å¯¼å…¥æˆåŠŸï¼";
        }

        function renderLibrary() {
            const list = document.getElementById('products-list');
            list.innerHTML = productLibrary.length ? '' : '<p style="color:gray;">æš‚æ— äº§å“æ•°æ®</p>';
            productLibrary.forEach(item => {
                const div = document.createElement('div');
                div.className = 'product-card';
                div.innerHTML = `<span>[${item.company}] ${item.fileName}</span><span class="delete-btn" onclick="deleteItem(${item.id})">åˆ é™¤</span>`;
                list.appendChild(div);
            });
        }

        function deleteItem(id) {
            productLibrary = productLibrary.filter(p => p.id !== id);
            localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
            renderLibrary();
        }

        function clearLibrary() { localStorage.clear(); productLibrary = []; renderLibrary(); }

        // --- ä¿®æ­£åçš„ AI è°ƒç”¨é€»è¾‘ ---
        async function runAI() {
            const reqs = document.getElementById('client-requirements').value;
            const btn = document.getElementById('analyze-btn');
            if(!productLibrary.length || !reqs) return alert("è¯·ç¡®ä¿å­˜å‚¨äº†äº§å“å¹¶å¡«å†™äº†éœ€æ±‚");

            btn.disabled = true;
            btn.innerText = "ğŸ” AI æ­£åœ¨æ·±å…¥å¯¹æ¯”äº§å“åº“...";

            const context = productLibrary.map(p => `äº§å“:${p.company}-${p.fileName},å†…å®¹:${p.content}`).join("\n");
            
            try {
                // é‡‡ç”¨ v1 è·¯å¾„å¹¶ä½¿ç”¨æœ€æ–°çš„ gemini-1.5-flash æ ‡è¯†ç¬¦
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${NEW_API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `ä½ æ˜¯ä¸€ä½ä¿é™©ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹äº§å“åº“ä¸ºå®¢æˆ·æ¨èæœ€åˆé€‚çš„ä¿é™©ã€‚å®¢æˆ·éœ€æ±‚ï¼š${reqs}ã€‚åº“å†…å®¹ï¼š${context}` }]
                        }]
                    })
                });

                const data = await response.json();

                // é”™è¯¯æ£€æµ‹
                if (data.error) {
                    throw new Error(`Google API æŠ¥é”™: ${data.error.message}`);
                }

                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    const md = data.candidates[0].content.parts[0].text;
                    document.getElementById('report-display').style.display = 'block';
                    document.getElementById('report-content').innerHTML = marked.parse(md);
                } else {
                    throw new Error("AI æ— æ³•æ ¹æ®å½“å‰åº“ç”Ÿæˆå»ºè®®ï¼Œè¯·å°è¯•ç¼©å‡ä¸Šä¼ çš„æ–‡ä»¶æ•°é‡ã€‚");
                }
            } catch (e) {
                alert("åˆ†æå¤±è´¥ï¼š" + e.message);
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆ AI å»ºè®®";
            }
        }
    </script>
</body>
</html>
