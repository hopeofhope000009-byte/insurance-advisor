<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¿é™©é¡¾é—®ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            line-height: 1.6;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        nav {
            display: flex;
            gap: 10px;
            justify-content: center;
            background: #1e40af;
            padding: 0.5rem;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.3s;
        }

        .nav-btn.active, .nav-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        main {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .section {
            background: var(--card);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: none;
        }

        .section.active { display: block; }

        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }

        .btn-primary:disabled { background: #94a3b8; }

        /* Report Styles */
        #report-display {
            margin-top: 2rem;
            padding: 2rem;
            background: white;
            border-top: 5px solid var(--primary);
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        #report-content {
            color: #334155;
            margin-top: 1rem;
        }

        #report-content h1, #report-content h2 { color: var(--primary); }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
        }

        .delete-btn { color: #ef4444; cursor: pointer; text-decoration: underline; font-size: 0.8rem; }

        @media print {
            header, nav, #upload, #library, .form-group, button { display: none !important; }
            #report-display { display: block !important; border: none; box-shadow: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <h1>ğŸ¥ ä¿é™©é¡¾é—® AI ç³»ç»Ÿ</h1>
            <span>ç¦»çº¿å­˜å‚¨ + äº‘ç«¯åˆ†æ</span>
        </div>
    </header>

    <nav>
        <button onclick="showSection('upload')" class="nav-btn active">ä¸Šä¼ äº§å“</button>
        <button onclick="showSection('library')" class="nav-btn">äº§å“åº“</button>
        <button onclick="showSection('client')" class="nav-btn">æ™ºèƒ½åˆ†æ</button>
    </nav>

    <main>
        <section id="upload" class="section active">
            <h2>ğŸ“ å¯¼å…¥ä¿é™©æ–‡ä»¶ (PDF)</h2>
            <form id="upload-form">
                <div class="form-group">
                    <label>ä¿é™©å…¬å¸:</label>
                    <input type="text" id="company-name" placeholder="å¦‚ï¼šå¹³å®‰ä¿é™©" required>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ–‡ä»¶å¤¹/æ–‡ä»¶:</label>
                    <input type="file" id="product-file" webkitdirectory directory multiple required>
                </div>
                <button type="submit" class="btn-primary">ä¿å­˜åˆ°æœ¬åœ°äº§å“åº“</button>
            </form>
            <div id="upload-status" style="margin-top:10px; color: green; display:none;"></div>
        </section>

        <section id="library" class="section">
            <h2>ğŸ“š æˆ‘çš„äº§å“åº“</h2>
            <button onclick="clearLibrary()" style="margin-bottom:10px; color:red; border:none; background:none; cursor:pointer;">æ¸…ç©ºåº“</button>
            <div id="products-list" class="products-grid"></div>
        </section>

        <section id="client" class="section">
            <h2>ğŸ“‹ å®¢æˆ·éœ€æ±‚ä¸ AI åˆ†æ</h2>
            <div class="form-group">
                <label>å®¢æˆ·å§“å:</label>
                <input type="text" id="client-name" placeholder="å®¢æˆ·å§“å">
            </div>
            <div class="form-group">
                <label>åˆ†æéœ€æ±‚:</label>
                <textarea id="client-requirements" rows="4" placeholder="ä¾‹å¦‚ï¼š30å²ç”·æ€§ï¼Œå¹´é¢„ç®—5000å…ƒï¼Œå…³æ³¨é‡ç–¾å’Œä½é™¢åŒ»ç–—ã€‚"></textarea>
            </div>
            <button class="btn-primary" id="analyze-btn" onclick="runAIAnalysis()">ç”Ÿæˆæ™ºèƒ½å»ºè®®æŠ¥å‘Š</button>

            <div id="report-display" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>ğŸ“Š AI æ–¹æ¡ˆå»ºè®®ä¹¦</h3>
                    <button onclick="window.print()" style="padding: 5px 10px; cursor: pointer;">æ‰“å°ä¸º PDF</button>
                </div>
                <div id="report-content"></div>
            </div>
        </section>
    </main>

    <script>
    // 1. Setup PDF.js
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let productLibrary = JSON.parse(localStorage.getItem('insurance_docs')) || [];
    
    // --- PLAN B: Direct Key ---
    const GEMINI_API_KEY = "AIzaSyCFzpAWoCorwVgcRwKqiDDwldzz7eJnBGc";

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (event) event.currentTarget.classList.add('active');
        if (id === 'library') renderLibrary();
    }

    async function extractTextFromPDF(file) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let text = "";
            const pages = Math.min(pdf.numPages, 3);
            for (let i = 1; i <= pages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(" ");
            }
            return text;
        } catch (e) { return ""; }
    }

    document.getElementById('upload-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button');
        btn.innerText = "â³ æ­£åœ¨è§£æ PDF...";
        btn.disabled = true;

        const company = document.getElementById('company-name').value;
        const files = document.getElementById('product-file').files;
        
        for (let file of files) {
            if (file.name.toLowerCase().endsWith('.pdf')) {
                const text = await extractTextFromPDF(file);
                productLibrary.push({
                    id: Date.now() + Math.random(),
                    fileName: file.name,
                    company: company,
                    content: text.substring(0, 3000)
                });
            }
        }
        localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
        btn.innerText = "ä¿å­˜åˆ°æœ¬åœ°äº§å“åº“";
        btn.disabled = false;
        document.getElementById('upload-status').innerText = "å¯¼å…¥æˆåŠŸï¼";
        document.getElementById('upload-status').style.display = "block";
    });

    // --- PLAN B: DIRECT AI CALL ---
    async function runAIAnalysis() {
        const name = document.getElementById('client-name').value;
        const reqs = document.getElementById('client-requirements').value;
        const btn = document.getElementById('analyze-btn');
        const display = document.getElementById('report-display');
        const content = document.getElementById('report-content');

        if (productLibrary.length === 0) return alert("è¯·å…ˆä¸Šä¼ ä¿é™©äº§å“ PDF");
        if (!reqs) return alert("è¯·è¾“å…¥å®¢æˆ·éœ€æ±‚");

        btn.innerText = "ğŸ§  æµè§ˆå™¨æ­£åœ¨ç›´è¿ AI åˆ†æä¸­...";
        btn.disabled = true;

        const context = productLibrary.map(p => `[äº§å“:${p.company}-${p.fileName}] å†…å®¹:${p.content}`).join("\n\n");
        const prompt = `ä½ æ˜¯ä¸€ä½ä¿é™©ä¸“å®¶ã€‚å®¢æˆ·ï¼š${name}ã€‚éœ€æ±‚ï¼š${reqs}ã€‚è¯·æ ¹æ®ä»¥ä¸‹åº“ä¸­äº§å“å†™ä¸€ä»½ä¸“ä¸šæŠ¥å‘Šï¼š${context}`;

        try {
            // We call Google directly from the browser here
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);

            const markdownText = data.candidates[0].content.parts[0].text;
            
            display.style.display = 'block';
            content.innerHTML = marked.parse(markdownText);
            display.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error(error);
            alert("AI åˆ†æå¤±è´¥: " + error.message);
        } finally {
            btn.innerText = "ç”Ÿæˆæ™ºèƒ½å»ºè®®æŠ¥å‘Š";
            btn.disabled = false;
        }
    }

    function renderLibrary() {
        const list = document.getElementById('products-list');
        list.innerHTML = productLibrary.length ? '' : '<p>æš‚æ— æ–‡ä»¶</p>';
        productLibrary.forEach(item => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `<strong>${item.fileName}</strong><br><small>${item.company}</small><br>
            <span class="delete-btn" onclick="deleteProduct(${item.id})">åˆ é™¤</span>`;
            list.appendChild(card);
        });
    }

    function deleteProduct(id) {
        productLibrary = productLibrary.filter(p => p.id !== id);
        localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
        renderLibrary();
    }

    function clearLibrary() {
        if(confirm('æ¸…ç©ºåº“ï¼Ÿ')) {
            productLibrary = [];
            localStorage.removeItem('insurance_docs');
            renderLibrary();
        }
    }
</script>
