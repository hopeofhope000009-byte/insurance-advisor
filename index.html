// ... (Keep your existing HTML and CSS, just update this specific part of the runAnalysis function)

async function runAnalysis() {
    const btn = document.getElementById('btn');
    const out = document.getElementById('out');
    const reqs = document.getElementById('reqs').value;

    if (productDB.length === 0) return alert("åº“é‡Œæ²¡ä¸œè¥¿ï¼Œè¯·å…ˆä¸Šä¼  PDFã€‚");
    if (!reqs) return alert("è¯·è¾“å…¥éœ€æ±‚ã€‚");

    btn.disabled = true;
    btn.innerText = "ğŸš€ AI æ­£åœ¨ç”Ÿæˆä¸“å®¶æŠ¥å‘Š...";

    // Context management: Only send the first 5 products to avoid "Input Token Limit"
    const selectedDocs = productDB.slice(0, 5);
    const prompt = `ä½ æ˜¯ä¸€ä½é¡¶çº§ä¿é™©ä¸“å®¶ã€‚éœ€æ±‚: ${reqs}ã€‚åº“ä¸­äº§å“æ•°æ®å¦‚ä¸‹: ${selectedDocs.map(d => d.content).join("\n")}`;

    try {
        // SWITCHED TO 1.5-FLASH for higher quota stability
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

        const data = await resp.json();
        
        if (data.error) {
            // If it still says Quota Exceeded, explain it to the user
            if (data.error.status === "RESOURCE_EXHAUSTED") {
                throw new Error("AI æ­¤æ—¶å¤ªå¿™ï¼ˆè§¦å‘é¢‘ç‡é™åˆ¶ï¼‰ï¼Œè¯·ç­‰å¾… 1 åˆ†é’Ÿåå†è¯•ã€‚");
            }
            throw new Error(data.error.message);
        }

        out.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
    } catch (e) {
        alert("ç”Ÿæˆå¤±è´¥: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "ç”Ÿæˆæ™ºèƒ½å»ºè®®æŠ¥å‘Š";
    }
}
