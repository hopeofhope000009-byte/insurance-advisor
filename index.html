<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¿é™©é¡¾é—® AI ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; }
        nav { display: flex; justify-content: center; background: #1e40af; padding: 0.5rem; gap: 10px; }
        .nav-btn { background: transparent; border: none; color: white; padding: 0.5rem 1rem; cursor: pointer; border-radius: 4px; }
        .nav-btn.active { background: rgba(255,255,255,0.2); }
        main { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .section.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1rem; }
        .btn-primary:disabled { background: #94a3b8; }
        #report-display { margin-top: 2rem; padding: 1.5rem; border-top: 4px solid var(--primary); background: #f0f7ff; }
        .product-card { border: 1px solid #e2e8f0; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; position: relative; }
        .delete-btn { color: #ef4444; cursor: pointer; font-size: 0.8rem; text-decoration: underline; }
    </style>
</head>
<body>

    <header><h1>ğŸ¥ ä¿é™©é¡¾é—® AI (ç›´è¿ç‰ˆ)</h1></header>
    <nav>
        <button onclick="showSection('upload', this)" class="nav-btn active">1. ä¸Šä¼ åº“</button>
        <button onclick="showSection('library', this)" class="nav-btn">2. äº§å“åº“</button>
        <button onclick="showSection('client', this)" class="nav-btn">3. å¼€å§‹åˆ†æ</button>
    </nav>

    <main>
        <section id="upload" class="section active">
            <h2>ğŸ“ å¯¼å…¥ä¿é™© PDF</h2>
            <div class="form-group">
                <label>å…¬å¸åç§°:</label>
                <input type="text" id="company-name" placeholder="å¦‚ï¼šå¹³å®‰ä¿é™©">
            </div>
            <div class="form-group">
                <label>é€‰æ‹© PDF æ–‡ä»¶:</label>
                <input type="file" id="product-file" multiple accept=".pdf">
            </div>
            <button onclick="handleUpload()" class="btn-primary" id="up-btn">ä¿å­˜åˆ°æœ¬åœ°</button>
        </section>

        <section id="library" class="section">
            <h2>ğŸ“š æˆ‘çš„äº§å“åº“</h2>
            <div id="products-list"></div>
            <button onclick="clearLibrary()" style="color:red; cursor:pointer; background:none; border:none;">[æ¸…ç©ºæ‰€æœ‰æ•°æ®]</button>
        </section>

        <section id="client" class="section">
            <h2>ğŸ“‹ å®¢æˆ·åˆ†æ</h2>
            <input type="text" id="client-name" placeholder="å®¢æˆ·å§“å" style="margin-bottom:1rem;">
            <textarea id="client-requirements" rows="4" placeholder="è¾“å…¥å®¢æˆ·å…·ä½“éœ€æ±‚..."></textarea>
            <button class="btn-primary" id="analyze-btn" onclick="runAI()">ç”Ÿæˆ AI å»ºè®®æŠ¥å‘Š</button>
            <div id="report-display" style="display:none;">
                <div id="report-content"></div>
            </div>
        </section>
    </main>

    <script>
        const GEMINI_KEY = "AIzaSyCFzpAWoCorwVgcRwKqiDDwldzz7eJnBGc";
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let productLibrary = JSON.parse(localStorage.getItem('insurance_docs')) || [];

        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'library') renderLibrary();
        }

        async function handleUpload() {
            const files = document.getElementById('product-file').files;
            const company = document.getElementById('company-name').value || "æœªçŸ¥å…¬å¸";
            const btn = document.getElementById('up-btn');
            
            if(!files.length) return alert("è¯·é€‰æ‹©æ–‡ä»¶");
            btn.disabled = true;
            btn.innerText = "è§£æä¸­...";

            for (let file of files) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                let text = "";
                for (let i = 1; i <= Math.min(pdf.numPages, 3); i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(" ");
                }
                productLibrary.push({ id: Date.now()+Math.random(), company, fileName: file.name, content: text.slice(0, 3000) });
            }
            localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
            btn.disabled = false;
            btn.innerText = "ä¿å­˜åˆ°æœ¬åœ°";
            alert("ä¸Šä¼ æˆåŠŸï¼");
        }

        function renderLibrary() {
            const list = document.getElementById('products-list');
            list.innerHTML = productLibrary.length ? '' : 'åº“ä¸­æ— æ•°æ®';
            productLibrary.forEach(item => {
                const div = document.createElement('div');
                div.className = 'product-card';
                div.innerHTML = `<strong>${item.company}</strong> - ${item.fileName} <br>
                <span class="delete-btn" onclick="deleteItem(${item.id})">åˆ é™¤</span>`;
                list.appendChild(div);
            });
        }

        function deleteItem(id) {
            productLibrary = productLibrary.filter(p => p.id !== id);
            localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
            renderLibrary();
        }

        function clearLibrary() { if(confirm('ç¡®å®šæ¸…ç©ºï¼Ÿ')) { productLibrary = []; localStorage.clear(); renderLibrary(); } }

        async function runAI() {
            const reqs = document.getElementById('client-requirements').value;
            const btn = document.getElementById('analyze-btn');
            if(!productLibrary.length || !reqs) return alert("è¯·ç¡®ä¿æœ‰äº§å“æ•°æ®å’Œå®¢æˆ·éœ€æ±‚");

            btn.disabled = true;
            btn.innerText = "AI åˆ†æä¸­ (ç›´è¿æ¨¡å¼)...";

            const context = productLibrary.map(p => `äº§å“:${p.company}-${p.fileName}, å†…å®¹:${p.content}`).join("\n");
            const prompt = `ä½ æ˜¯ä¸€ä¸ªä¿é™©ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹äº§å“åº“å»ºè®®æœ€åˆé€‚çš„æ–¹æ¡ˆã€‚éœ€æ±‚ï¼š${reqs}ã€‚åº“ï¼š${context}`;

            try {
                // æ³¨æ„ï¼šè¿™é‡Œç›´æ¥è®¿é—® Google æ¥å£ï¼Œä¸ç»è¿‡ Vercel api æ–‡ä»¶å¤¹
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await resp.json();
                const md = data.candidates[0].content.parts[0].text;
                document.getElementById('report-display').style.display = 'block';
                document.getElementById('report-content').innerHTML = marked.parse(md);
            } catch (e) {
                alert("åˆ†æå¤±è´¥ï¼š" + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆ AI å»ºè®®æŠ¥å‘Š";
            }
        }
    </script>
</body>
</html>
