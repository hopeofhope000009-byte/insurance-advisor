<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI ä¿é™©ä¸“å®¶ - ç¨³å®šç‰ˆ</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>

    <!-- Markdown æ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- XSS è¿‡æ»¤ -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f0f4f8; padding: 20px; line-height: 1.5; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card { border: 2px solid #e2e8f0; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #fff; }
        .upload-zone { border: 2px dashed #3b82f6; padding: 20px; text-align: center; background: #eff6ff; margin-bottom: 10px; border-radius: 8px; }
        button { padding: 12px; cursor: pointer; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.2s; }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
        #status { color: #2563eb; font-weight: bold; margin: 10px 0; }
        textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        #out { margin-top: 20px; padding: 20px; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; min-height: 100px; }
        .reset-btn { background: #dc2626; width: auto; font-size: 12px; margin-top: 30px; display: block; margin-left: auto; margin-right: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#1e40af;">ğŸ›¡ï¸ ä¸ªäººä¿é™©é¡¾é—® AI</h2>
    
    <div class="card">
        <h3>1. å¯¼å…¥äº§å“ PDF (å»ºè®®æ¯æ¬¡ 3-5 ä¸ª)</h3>
        <div class="upload-zone">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">é€‰æ‹©å¤šä¸ª PDF æ–‡ä»¶:</label>
            <input type="file" id="fileInput" accept=".pdf" multiple>
        </div>
        <button id="upBtn" onclick="handleUpload()">è§£æå¹¶å­˜å…¥åº“</button>
        <div id="status">ç³»ç»Ÿå‡†å¤‡å°±ç»ª</div>
    </div>

    <div class="card">
        <h3>2. å®¢æˆ·éœ€æ±‚åˆ†æ</h3>
        <textarea id="reqs" rows="4" placeholder="ä¾‹å¦‚ï¼š30å²ç”·æ€§ï¼Œå¹´é¢„ç®—1ä¸‡ï¼Œæƒ³è¦é‡ç–¾åŠ åŒ»ç–—ï¼Œå…³æ³¨å…èµ”é¢..."></textarea>
        <button id="btn" onclick="runAnalysis()">ç”Ÿæˆæ™ºèƒ½å»ºè®®æŠ¥å‘Š</button>
    </div>

    <div id="out">æŠ¥å‘Šç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    
    <button class="reset-btn" onclick="clearData()">æ¸…ç©ºæ•°æ®åº“å¹¶é‡ç½®ç³»ç»Ÿ</button>
</div>

<script>
    // âš ï¸ æ³¨æ„ï¼šçœŸå®ç¯å¢ƒè¯·ä¸è¦æŠŠ API Key æ”¾å‰ç«¯
    const KEY = "AIzaSyArJg6XfI4gWHhK46xsMc0zHUdJlfa98QY";

    // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
    let productDB = JSON.parse(localStorage.getItem('insurance_docs')) || [];

    // PDF.js å¼•ç”¨ä¿®å¤
    const pdfjsLib = window['pdfjsLib'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    async function handleUpload() {
        const files = document.getElementById('fileInput').files;
        const status = document.getElementById('status');
        const upBtn = document.getElementById('upBtn');

        if (files.length === 0) return alert("è¯·å…ˆé€‰æ‹© PDF æ–‡ä»¶ï¼");

        upBtn.disabled = true;
        status.innerText = "â³ æ­£åœ¨æå–æ–‡æœ¬ï¼ˆè¯·å‹¿åˆ·æ–°ï¼‰...";
        let count = 0;

        for (let file of files) {
            if (file.name.toLowerCase().endsWith('.pdf')) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let text = "";

                    for (let i = 1; i <= Math.min(pdf.numPages, 2); i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(it => it.str).join(" ");
                    }

                    productDB.push({ name: file.name, content: text.slice(0, 2500) });
                    count++;
                    status.innerText = `â³ æˆåŠŸè§£æç¬¬ ${count} ä¸ªäº§å“...`;

                } catch (e) {
                    console.error("è§£æå¤±è´¥:", file.name);
                }
            }
        }

        try {
            localStorage.setItem('insurance_docs', JSON.stringify(productDB));
            status.innerText = `âœ… å¯¼å…¥å®Œæˆï¼åº“ä¸­ç°æœ‰ ${productDB.length} ä¸ªäº§å“ã€‚`;
        } catch (e) {
            alert("æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·å°è¯•æ¸…ç©ºæ•°æ®ã€‚");
        }

        upBtn.disabled = false;
    }

    // è°ƒç”¨ AI åˆ†æ
    async function runAnalysis() {
        const btn = document.getElementById('btn');
        const out = document.getElementById('out');
        const reqs = document.getElementById('reqs').value;

        if (productDB.length === 0) return alert("è¯·å…ˆä¸Šä¼  PDF äº§å“ã€‚");
        if (!reqs) return alert("è¯·è¾“å…¥éœ€æ±‚ã€‚");

        btn.disabled = true;
        btn.innerText = "ğŸš€ AI æ­£åœ¨æ’°å†™æ–¹æ¡ˆï¼ˆçº¦ 10-20 ç§’ï¼‰...";

        const activeDocs = productDB.slice(-5);

        const prompt = `
ä½ æ˜¯ä¸€ä½ä¿é™©ç²¾ç®—ä¸“å®¶ã€‚
å®¢æˆ·éœ€æ±‚ï¼š${reqs}

ä»¥ä¸‹æ˜¯å¯é€‰äº§å“çš„å†…å®¹æ‘˜è¦ï¼š
${activeDocs.map(d => `[äº§å“å: ${d.name}] å†…å®¹: ${d.content}`).join("\n\n")}

ä»»åŠ¡ï¼šå¯¹æ¯”ä»¥ä¸Šäº§å“ï¼Œç»™å®¢æˆ·ä¸€ä¸ªæœ€åˆç†çš„æ–¹æ¡ˆå»ºè®®ã€‚
        `;

        try {
            const resp = await fetch(
                `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${KEY}`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                }
            );

            const data = await resp.json();

            if (data.error) throw new Error(data.error.message);

            const mdText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!mdText) throw new Error("AI æ— å“åº”ï¼Œè¯·é‡è¯•ã€‚");

            // å®‰å…¨æ¸²æŸ“ Markdown
            out.innerHTML = DOMPurify.sanitize(marked.parse(mdText));
            out.scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            alert("ç”Ÿæˆå¤±è´¥: " + e.message);
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerText = "ç”Ÿæˆæ™ºèƒ½å»ºè®®æŠ¥å‘Š";
        }
    }

    function clearData() {
        if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²ä¸Šä¼ çš„äº§å“å—ï¼Ÿ")) {
            localStorage.clear();
            productDB = [];
            location.reload();
        }
    }
</script>

</body>
</html>
