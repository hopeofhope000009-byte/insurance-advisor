<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI ä¿é™©ä¸“å®¶ - å…¼å®¹æ€§ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; background: #f0f4f8; padding: 20px; line-height: 1.5; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card { border: 2px solid #e2e8f0; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #fff; }
        .upload-zone { border: 2px dashed #3b82f6; padding: 20px; text-align: center; background: #eff6ff; margin-bottom: 10px; }
        button { padding: 12px; cursor: pointer; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 10px; }
        button:disabled { background: #94a3b8; }
        #status { color: #2563eb; font-weight: bold; margin: 10px 0; }
        textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        #out { margin-top: 20px; padding: 20px; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#1e40af;">ğŸ›¡ï¸ ä¿é™©é¡¾é—® AI (å…¼å®¹ç‰ˆæœ¬)</h2>
    
    <div class="card">
        <h3>1. å¯¼å…¥äº§å“ PDF</h3>
        <p style="font-size: 0.9em; color: #64748b;">å¦‚æœæ–‡ä»¶å¤¹ä¸Šä¼ ä¸æ˜¾ç¤ºæ–‡ä»¶ï¼Œè¯·ä½¿ç”¨â€œé€‰æ‹©å¤šä¸ªæ–‡ä»¶â€æŒ‰é’®ã€‚</p>
        
        <div class="upload-zone">
            <label>æ–¹å¼ A (æ•´æ–‡ä»¶å¤¹): </label>
            <input type="file" id="folderInput" webkitdirectory directory multiple>
            <br><br>
            <label>æ–¹å¼ B (é€‰å¤šä¸ªæ–‡ä»¶): </label>
            <input type="file" id="fileInput" accept=".pdf" multiple>
        </div>

        <button id="upBtn" onclick="handleUpload()">è§£æå¹¶å¯¼å…¥åº“</button>
        <div id="status">å‡†å¤‡å°±ç»ª</div>
    </div>

    <div class="card">
        <h3>2. å®¢æˆ·éœ€æ±‚åˆ†æ</h3>
        <textarea id="reqs" rows="4" placeholder="ä¾‹å¦‚ï¼š30å²ç”·æ€§ï¼Œå¹´é¢„ç®—1ä¸‡ï¼Œæƒ³è¦é‡ç–¾åŠ åŒ»ç–—..."></textarea>
        <button id="btn" onclick="runAnalysis()">ç”Ÿæˆæ™ºèƒ½å»ºè®®æŠ¥å‘Š</button>
    </div>

    <div id="out">æŠ¥å‘Šå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    
    <div style="text-align:center; margin-top:30px;">
        <button onclick="localStorage.clear(); location.reload();" style="background:#dc2626; width:auto; font-size:12px;">æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶åˆ·æ–°</button>
    </div>
</div>

<script>
    const KEY = "AIzaSyArJg6XfI4gWHhK46xsMc0zHUdJlfa98QY";
    let productDB = JSON.parse(localStorage.getItem('insurance_docs')) || [];

    // PDF Worker Config
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    async function handleUpload() {
        // Try to get files from either input
        const folderFiles = document.getElementById('folderInput').files;
        const individualFiles = document.getElementById('fileInput').files;
        const files = folderFiles.length > 0 ? folderFiles : individualFiles;

        const status = document.getElementById('status');
        const upBtn = document.getElementById('upBtn');

        if (files.length === 0) return alert("æœªæ£€æµ‹åˆ°æ–‡ä»¶ï¼è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶ã€‚");

        upBtn.disabled = true;
        status.innerText = "â³ æ­£åœ¨æå– PDF æ–‡æœ¬...";
        let count = 0;

        for (let file of files) {
            if (file.name.toLowerCase().endsWith('.pdf')) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let text = "";
                    // Read top 3 pages
                    for (let i = 1; i <= Math.min(pdf.numPages, 3); i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(it => it.str).join(" ");
                    }
                    productDB.push({ name: file.name, content: text.slice(0, 3000) });
                    count++;
                    status.innerText = `â³ æ­£åœ¨è§£æç¬¬ ${count} ä¸ªæ–‡ä»¶...`;
                } catch (e) {
                    console.error("è§£æé”™è¯¯:", file.name);
                }
            }
        }

        try {
            localStorage.setItem('insurance_docs', JSON.stringify(productDB));
            status.innerText = `âœ… æˆåŠŸï¼å½“å‰åº“ä¸­å…±æœ‰ ${productDB.length} ä¸ªäº§å“ã€‚`;
        } catch (e) {
            alert("æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·å…ˆæ¸…ç©ºæ•°æ®ã€‚");
        }
        upBtn.disabled = false;
    }

    async function runAnalysis() {
        const btn = document.getElementById('btn');
        const out = document.getElementById('out');
        const reqs = document.getElementById('reqs').value;

        if (productDB.length === 0) return alert("åº“é‡Œæ²¡ä¸œè¥¿ï¼Œè¯·å…ˆä¸Šä¼  PDFã€‚");
        if (!reqs) return alert("è¯·è¾“å…¥éœ€æ±‚ã€‚");

        btn.disabled = true;
        btn.innerText = "ğŸš€ AI 2.0 æ­£åœ¨ç”Ÿæˆä¸“å®¶æŠ¥å‘Š...";

        const prompt = `ä½ æ˜¯ä¸€ä½é¡¶çº§ä¿é™©ä¸“å®¶ã€‚éœ€æ±‚: ${reqs}ã€‚åº“ä¸­äº§å“æ•°æ®å¦‚ä¸‹: ${productDB.map(d => d.content).join("\n")}`;

        try {
            // Using your confirmed working Gemini 2.0 Flash
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await resp.json();
            if (data.error) throw new Error(data.error.message);

            out.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
        } catch (e) {
            alert("ç”Ÿæˆå¤±è´¥: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "ç”Ÿæˆæ™ºèƒ½å»ºè®®æŠ¥å‘Š";
        }
    }
</script>
</body>
</html>
