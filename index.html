<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿é™©é¡¾é—® AI - æœ€ç»ˆä¿®å¤ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; line-height: 1.6; }
        header { background: var(--primary); color: white; padding: 1.5rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        nav { display: flex; justify-content: center; background: #1e40af; padding: 0.5rem; gap: 10px; position: sticky; top: 0; z-index: 100; }
        .nav-btn { background: transparent; border: none; color: white; padding: 0.6rem 1.2rem; cursor: pointer; border-radius: 4px; font-weight: 500; transition: 0.2s; }
        .nav-btn.active { background: rgba(255,255,255,0.2); box-shadow: inset 0 0 0 1px white; }
        main { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        .section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #475569; }
        input, textarea { width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 6px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        #report-display { margin-top: 2rem; padding: 2rem; border-radius: 8px; background: #ffffff; border: 1px solid #e2e8f0; }
        .product-card { background: #f8fafc; padding: 1rem; margin-bottom: 0.8rem; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { color: #ef4444; cursor: pointer; font-size: 0.9rem; font-weight: bold; }
        .loading-ring { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header><h1>ğŸ¥ ä¸ªäººä¿é™©é¡¾é—® AI ç³»ç»Ÿ</h1></header>
    
    <nav>
        <button onclick="showSection('upload', this)" class="nav-btn active">1. æ‰¹é‡ä¸Šä¼ </button>
        <button onclick="showSection('library', this)" class="nav-btn">2. äº§å“åº“</button>
        <button onclick="showSection('client', this)" class="nav-btn">3. æ™ºèƒ½åˆ†æ</button>
    </nav>

    <main>
        <section id="upload" class="section active">
            <h2>ğŸ“ æ‰¹é‡å¯¼å…¥æ–‡ä»¶å¤¹</h2>
            <p style="color: #64748b;">æ”¯æŒé€‰æ‹©æ•´ä¸ªæ–‡ä»¶å¤¹ã€‚ç³»ç»Ÿå°†è‡ªåŠ¨è¯»å–æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰ PDF æ–‡ä»¶ã€‚</p>
            <div class="form-group">
                <label>æ‰€å±ä¿é™©å…¬å¸:</label>
                <input type="text" id="company-name" placeholder="å¦‚ï¼šä¸­å›½å¹³å®‰ã€å‹é‚¦ä¿é™©">
            </div>
            <div class="form-group">
                <label>é€‰æ‹©æ–‡ä»¶å¤¹:</label>
                <input type="file" id="product-file" webkitdirectory directory multiple>
            </div>
            <button onclick="handleUpload()" class="btn-primary" id="up-btn">å¼€å§‹æ‰¹é‡è§£æå¹¶å¯¼å…¥</button>
            <div id="up-progress" style="margin-top:15px; font-weight:600; color:var(--primary);"></div>
        </section>

        <section id="library" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                <h2>ğŸ“š äº§å“åº“çŠ¶æ€</h2>
                <button onclick="clearLibrary()" style="color:#ef4444; border:none; background:none; cursor:pointer; font-weight:bold;">[æ¸…ç©ºåº“]</button>
            </div>
            <div id="products-list"></div>
        </section>

        <section id="client" class="section">
            <h2>ğŸ“‹ å®¢æˆ·éœ€æ±‚åˆ†æ</h2>
            <div class="form-group">
                <label>å®¢æˆ·å…·ä½“éœ€æ±‚:</label>
                <textarea id="client-requirements" rows="6" placeholder="è¯·æè¿°å®¢æˆ·çš„æƒ…å†µï¼ˆå¹´é¾„ã€é¢„ç®—ã€ä¿éšœåå¥½ç­‰ï¼‰..."></textarea>
            </div>
            <button class="btn-primary" id="analyze-btn" onclick="runAI()">ç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Š</button>
            
            <div id="report-display" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;">
                    <h3 style="margin:0;">ğŸ“Š AI æ–¹æ¡ˆå»ºè®®</h3>
                    <button onclick="window.print()" style="padding:5px 15px; cursor:pointer;">æ‰“å°ä¸º PDF</button>
                </div>
                <div id="report-content"></div>
            </div>
        </section>
    </main>

    <script>
        const GEMINI_KEY = "AIzaSyCFzpAWoCorwVgcRwKqiDDwldzz7eJnBGc";
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let productLibrary = JSON.parse(localStorage.getItem('insurance_docs')) || [];

        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'library') renderLibrary();
        }

        async function handleUpload() {
            const files = document.getElementById('product-file').files;
            const company = document.getElementById('company-name').value || "é»˜è®¤å…¬å¸";
            const btn = document.getElementById('up-btn');
            const progress = document.getElementById('up-progress');
            
            if(!files.length) return alert("è¯·é€‰æ‹©åŒ…å« PDF çš„æ–‡ä»¶å¤¹ï¼");
            
            btn.disabled = true;
            let successCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.name.toLowerCase().endsWith('.pdf')) {
                    progress.innerText = `æ­£åœ¨å¤„ç† (${i+1}/${files.length}): ${file.name}`;
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                        let text = "";
                        // Capture first 3 pages to prevent localStorage overflow
                        for (let p = 1; p <= Math.min(pdf.numPages, 3); p++) {
                            const page = await pdf.getPage(p);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ");
                        }
                        productLibrary.push({ 
                            id: Date.now() + Math.random(), 
                            company, 
                            fileName: file.name, 
                            content: text.slice(0, 3500) 
                        });
                        successCount++;
                    } catch (err) { console.error("PDF Read Error:", file.name); }
                }
            }

            localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
            btn.disabled = false;
            progress.innerText = `âœ… æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªæ–‡ä»¶ï¼`;
        }

        function renderLibrary() {
            const list = document.getElementById('products-list');
            list.innerHTML = productLibrary.length ? '' : '<p>åº“ä¸­æ²¡æœ‰äº§å“ï¼Œè¯·å…ˆä¸Šä¼ ã€‚</p>';
            productLibrary.forEach(item => {
                const div = document.createElement('div');
                div.className = 'product-card';
                div.innerHTML = `<div><strong>[${item.company}]</strong> ${item.fileName}</div>
                <span class="delete-btn" onclick="deleteItem(${item.id})">åˆ é™¤</span>`;
                list.appendChild(div);
            });
        }

        function deleteItem(id) {
            productLibrary = productLibrary.filter(p => p.id !== id);
            localStorage.setItem('insurance_docs', JSON.stringify(productLibrary));
            renderLibrary();
        }

        function clearLibrary() { if(confirm('æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) { productLibrary = []; localStorage.removeItem('insurance_docs'); renderLibrary(); } }

        // THE CORE AI FUNCTION - FIXED URL AND ERROR HANDLING
        async function runAI() {
            const reqs = document.getElementById('client-requirements').value;
            const btn = document.getElementById('analyze-btn');
            const reportDiv = document.getElementById('report-display');
            const contentDiv = document.getElementById('report-content');

            if(!productLibrary.length) return alert("åº“ä¸­æ— äº§å“ï¼Œæ— æ³•åˆ†æã€‚");
            if(!reqs) return alert("è¯·è¾“å…¥å®¢æˆ·éœ€æ±‚ã€‚");

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-ring"></span> AI æ­£åœ¨åˆ†æåº“æ–‡ä»¶å¹¶ç”ŸæˆæŠ¥å‘Š...';

            const context = productLibrary.map(p => `[å…¬å¸:${p.company}, æ–‡ä»¶:${p.fileName}] å†…å®¹:${p.content}`).join("\n---\n");
            
            const prompt = `ä½ æ˜¯ä¸€ä½ä¿é™©ä¸“å®¶ã€‚
            å®¢æˆ·èƒŒæ™¯éœ€æ±‚ï¼š${reqs}
            
            äº§å“åº“ï¼š
            ${context}
            
            ä»»åŠ¡ï¼š
            è¯·ä»äº§å“åº“ä¸­é€‰å‡ºæœ€åŒ¹é…çš„äº§å“ï¼Œå¹¶ç»™å‡ºè¯¦ç»†çš„æ¨èç†ç”±å’Œå¯¹æ¯”åˆ†æã€‚`;

            try {
                // FIXED ENDPOINT: Using v1 stable
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await resp.json();

                if (data.error) {
                    throw new Error(data.error.message || "API é”™è¯¯");
                }

                if (data && data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    const md = data.candidates[0].content.parts[0].text;
                    reportDiv.style.display = 'block';
                    contentDiv.innerHTML = marked.parse(md);
                    reportDiv.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error("AI å“åº”æ ¼å¼å¼‚å¸¸ï¼Œè¯·é‡è¯•ã€‚");
                }
            } catch (e) {
                alert("åˆ†æå¤±è´¥ï¼š" + e.message);
                console.error("AI Error:", e);
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Š";
            }
        }
    </script>
</body>
</html>
