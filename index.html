<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¿é™©é¡¾é—® AI - åº”æ€¥ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:disabled { background: #ccc; }
        #log { font-family: monospace; font-size: 12px; background: #000; color: #0f0; padding: 10px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¥ ä¿é™©é¡¾é—® AI (åº”æ€¥ç‰ˆ)</h2>
    
    <div class="card">
        <h3>1. å¯¼å…¥ PDF</h3>
        <input type="file" id="files" webkitdirectory directory multiple>
        <button onclick="upload()">è§£ææ–‡ä»¶å¤¹</button>
        <div id="status"></div>
    </div>

    <div class="card">
        <h3>2. åˆ†æéœ€æ±‚</h3>
        <textarea id="reqs" rows="4" style="width:100%" placeholder="è¾“å…¥å®¢æˆ·éœ€æ±‚..."></textarea>
        <button id="btn" onclick="run()">å¼€å§‹åˆ†æ</button>
        <button onclick="checkModels()" style="background:#6c757d">è°ƒè¯•: æŸ¥çœ‹å¯ç”¨æ¨¡å‹</button>
    </div>

    <div id="log"></div>
    <div id="out" style="margin-top:20px; border-top: 2px solid #007bff; padding-top: 20px;"></div>
</div>

<script>
    const KEY = "AIzaSyArJg6XfI4gWHhK46xsMc0zHUdJlfa98QY";
    let db = JSON.parse(localStorage.getItem('docs')) || [];

    async function upload() {
        const files = document.getElementById('files').files;
        for (let f of files) {
            if (f.name.endsWith('.pdf')) {
                const doc = await window['pdfjs-dist/build/pdf'].getDocument({data: await f.arrayBuffer()}).promise;
                let t = "";
                for (let i=1; i<=Math.min(doc.numPages, 2); i++) {
                    t += (await (await doc.getPage(i)).getTextContent()).items.map(it => it.str).join(" ");
                }
                db.push({ name: f.name, text: t.slice(0, 2000) });
            }
        }
        localStorage.setItem('docs', JSON.stringify(db));
        alert("å¯¼å…¥æˆåŠŸï¼å·²å­˜å…¥æµè§ˆå™¨ã€‚");
    }

    // DEBUG: See what Google actually allows you to use
    async function checkModels() {
        const l = document.getElementById('log');
        l.style.display = 'block';
        l.innerText = "æ­£åœ¨è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨...";
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1/models?key=${KEY}`);
            const d = await r.json();
            l.innerText = JSON.stringify(d, null, 2);
        } catch (e) { l.innerText = "æ— æ³•è¿æ¥ API"; }
    }

    async function run() {
        const btn = document.getElementById('btn');
        btn.disabled = true;
        btn.innerText = "å°è¯•è¿æ¥ä¸­...";

        const prompt = `ä½ æ˜¯ä¸€ä¸ªä¿é™©ä¸“å®¶ã€‚éœ€æ±‚: ${document.getElementById('reqs').value}ã€‚åº“: ${db.map(d=>d.text).join("\n")}`;

        // We try "gemini-pro" (1.0) which is often more compatible with browser keys
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${KEY}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const d = await r.json();
            if (d.error) throw new Error(d.error.message);

            document.getElementById('out').innerHTML = marked.parse(d.candidates[0].content.parts[0].text);
        } catch (e) {
            alert("åˆ†æåˆå¤±è´¥äº†: " + e.message + "\nè¯·ç‚¹å‡»å³ä¾§'è°ƒè¯•'æŒ‰é’®çœ‹åˆ—è¡¨ã€‚");
        } finally {
            btn.disabled = false;
            btn.innerText = "å¼€å§‹åˆ†æ";
        }
    }
</script>
</body>
</html>
