<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI ä¿é™©ä¸“å®¶ - ä¿®å¤ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card { border: 2px dashed #cbd5e1; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #fafafa; }
        button { padding: 12px; cursor: pointer; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 10px; }
        button:hover { background: #1d4ed8; }
        #status { color: #059669; font-weight: bold; margin: 10px 0; min-height: 1.2em; }
        textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        #out { margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; line-height: 1.6; }
        .admin-tools { margin-top: 40px; border-top: 1px solid #eee; padding-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#1e40af;">ğŸ¥ ä¿é™©é¡¾é—® AI ç³»ç»Ÿ</h2>
    
    <div class="card">
        <h3>1. å¯¼å…¥äº§å“ (PDF æˆ– æ–‡ä»¶å¤¹)</h3>
        <input type="file" id="files" webkitdirectory directory multiple>
        <button onclick="handleUpload()">è§£æå¹¶å¯¼å…¥æ–‡ä»¶</button>
        <div id="status"></div>
    </div>

    <div class="card">
        <h3>2. å®¢æˆ·åˆ†æ</h3>
        <textarea id="reqs" rows="4" placeholder="è¾“å…¥å®¢æˆ·éœ€æ±‚..."></textarea>
        <button id="btn" onclick="runAnalysis()">å¼€å§‹ç”ŸæˆæŠ¥å‘Š</button>
    </div>

    <div id="out"></div>

    <div class="admin-tools">
        <button onclick="resetSystem()" style="background:#ef4444; width: auto; font-size: 12px;">é‡ç½®ç³»ç»Ÿ (æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ•°æ®)</button>
    </div>
</div>

<script>
    const KEY = "AIzaSyArJg6XfI4gWHhK46xsMc0zHUdJlfa98QY";
    let productDB = JSON.parse(localStorage.getItem('insurance_docs')) || [];

    // Initialize PDF.js
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    async function handleUpload() {
        const fileInput = document.getElementById('files');
        const status = document.getElementById('status');
        const files = fileInput.files;

        if (files.length === 0) return alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹");

        status.innerText = "â³ æ­£åœ¨è¯»å–æ–‡ä»¶...";
        let count = 0;

        for (let file of files) {
            if (file.name.toLowerCase().endsWith('.pdf')) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let text = "";
                    // Read first 2 pages (to keep it fast and light)
                    for (let i = 1; i <= Math.min(pdf.numPages, 2); i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(" ");
                    }
                    productDB.push({ name: file.name, content: text.slice(0, 2500) });
                    count++;
                    status.innerText = `â³ å·²è§£æ ${count} ä¸ª PDF...`;
                } catch (e) {
                    console.error("æ— æ³•è§£æ:", file.name);
                }
            }
        }

        try {
            localStorage.setItem('insurance_docs', JSON.stringify(productDB));
            status.innerText = `âœ… æˆåŠŸå¯¼å…¥ ${count} ä¸ªäº§å“ï¼å½“å‰æ€»æ•°: ${productDB.length}`;
        } catch (e) {
            alert("å­˜å‚¨ç©ºé—´å·²æ»¡ï¼è¯·ç‚¹å‡»ä¸‹æ–¹çš„é‡ç½®æŒ‰é’®æ¸…ç©ºæ•°æ®åå†è¯•ã€‚");
        }
    }

    async function runAnalysis() {
        const btn = document.getElementById('btn');
        const out = document.getElementById('out');
        const reqs = document.getElementById('reqs').value;

        if (productDB.length === 0) return alert("è¯·å…ˆä¸Šä¼  PDF äº§å“");
        if (!reqs) return alert("è¯·è¾“å…¥å®¢æˆ·éœ€æ±‚");

        btn.disabled = true;
        btn.innerText = "ğŸš€ AI 2.0 æ­£åœ¨åˆ†æä¸­...";

        const prompt = `ä½ æ˜¯ä¸€ä½ä¿é™©ä¸“å®¶ã€‚éœ€æ±‚: ${reqs}ã€‚ä»¥ä¸‹æ˜¯å¯é€‰äº§å“å†…å®¹: ${productDB.map(d => d.content).join("\n")}`;

        try {
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await resp.json();
            if (data.error) throw new Error(data.error.message);

            out.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
        } catch (e) {
            alert("åˆ†æå¤±è´¥: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "å¼€å§‹ç”ŸæˆæŠ¥å‘Š";
        }
    }

    function resetSystem() {
        if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²ä¸Šä¼ çš„äº§å“æ•°æ®å—ï¼Ÿ")) {
            localStorage.removeItem('insurance_docs');
            productDB = [];
            document.getElementById('status').innerText = "ç³»ç»Ÿå·²é‡ç½®";
            document.getElementById('out').innerHTML = "";
            location.reload();
        }
    }
</script>
</body>
</html>
